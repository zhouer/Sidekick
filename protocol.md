# Sidekick Communication Protocol Specification

## 1. Introduction

This document specifies the communication protocol used within the Sidekick ecosystem. It facilitates communication between the **Hero** (user's script using the `sidekick` library) and the **Sidekick** frontend (React application). Currently, this communication is relayed through a **Server** component, but the protocol is designed with the flexibility to potentially support other topologies in the future.

The protocol enables:
*   **Peer Discovery & Status:** Allows connected components (Peers) to announce their presence, role, version, and status (`online`/`offline`). This allows peers to know when others are ready to receive messages.
*   **Global Operations:** Provides types for system-wide actions, such as clearing all module instances.
*   **Module Control:** Enables the Hero to create, update, and remove visual modules in the Sidekick UI.
*   **Module Feedback:** Allows Sidekick to send user interaction events and error reports back to the Hero.

## 2. Transport Layer

*   **Mechanism:** WebSocket
*   **Default Endpoint:** `ws://localhost:5163` (Configurable via `sidekick.set_url()`). The server listens on this endpoint, and peers connect to it.
*   **Encoding:** JSON strings (UTF-8 encoded).
*   **Keep-Alive:** The Python client (`hero`) uses WebSocket Ping/Pong frames for connection maintenance and failure detection (after disabling underlying socket timeout). The server should respond to Pings with Pongs. Sidekick frontend relies on browser WebSocket implementation.

## 3. Message Format

All messages exchanged within the Sidekick ecosystem share a common JSON structure. Keys within the `payload` object **MUST** use `camelCase`.

```json
{
  "id": number,       // Reserved. Defaults to 0.
  "module": string,   // Target/Source module type (e.g., "grid", "system", "global").
  "type": string,     // The message type or action (e.g., "spawn", "announce", "clearAll", "event").
  "target"?: string,  // Identifier of the target module instance (for module control).
  "src"?: string,      // Identifier of the source module instance (for module feedback).
  "payload": object | null // Type-specific data. Keys MUST be camelCase.
}
```

### 3.1 Field Descriptions

*   `id` (Integer): Reserved. Defaults to `0`.
*   `module` (String): Identifies the type of module or system component involved (e.g., `grid`, `system`, `global`).
*   `type` (String): Specifies the message type or action (e.g., `spawn`, `update`, `remove`, `announce`, `event`, `error`, `clearAll`).
*   `target` (String, Optional): **Present** for module control messages (`spawn`, `update`, `remove`) sent from Hero. Identifies the specific module instance in Sidekick being controlled. **Omitted** otherwise.
*   `src` (String, Optional): **Present** for module feedback messages (`event`, `error`) sent from Sidekick. Identifies the specific module instance in Sidekick that generated the message. **Omitted** otherwise.
*   `payload` (Object | Null): Contains type-specific data structures detailed in subsequent sections. **Null or omitted** for types like `global/clearAll`. Keys within this object **MUST** be `camelCase`.

## 4. Connection Lifecycle & Peer Discovery (`system` module)

Peers (Hero or Sidekick instances) use the `system` module and `announce` type to manage their online status and discover other connected peers. Receiving an `online` announcement indicates that the announcing peer is connected and ready to process messages according to its role.

### 4.1 Type: `announce`

*   **Direction:** Peer -> Server / Other Peers
*   **Purpose:** Announce connection status (`online`/`offline`), role, and version. Signals readiness to other peers.
*   **`target` / `src`:** Omitted.

### 4.2 `announce` Payload

Sent by a peer upon successful connection (`status: "online"`) and optionally upon graceful disconnection (`status: "offline"`). A server might also generate an `offline` announcement on behalf of a peer that disconnected abnormally. **All keys MUST be `camelCase`.**

```json
{
  "peerId": string,             // Unique identifier for the peer instance (e.g., UUID). Generated by the peer.
  "role": "hero" | "sidekick",  // Role of the announcing peer.
  "status": "online" | "offline", // Current status.
  "version": string,            // Version of the peer library/app (e.g., "0.1.0").
  "timestamp": number           // Timestamp of the announcement (Unix epoch milliseconds).
}
```

### 4.3 Connection Flow & Disconnection Handling

1.  **Connection:** A peer (Hero or Sidekick) connects to the Server via WebSocket.
2.  **Online Announcement:** Upon successful connection, the peer immediately sends an `announce` message (`type: "announce"`) with `status: "online"`.
3.  **Server Broadcast & History:**
    *   The Server records the new peer's information.
    *   The Server **broadcasts** this `online` announcement to all *other* currently connected peers. Peers can now recognize this new peer is ready (e.g., Hero knows Sidekick is ready).
    *   The Server sends a list of previously received `online` announcements (from currently connected peers) **only to the newly connected peer**.
4.  **Peer Records:** Each peer receiving an `announce` message should record the information about the other peer.
5.  **Hero Message Buffering (Client Implementation):** A Hero peer SHOULD buffer non-`system` messages until it receives an `online` announcement from at least one Sidekick peer.
6.  **Normal Disconnection:**
    *   A peer SHOULD send an `announce` message (`type: "announce"`) with `status: "offline"` before closing the connection.
    *   The Server broadcasts this `offline` message.
    *   Peers update the status locally.
7.  **Abnormal Disconnection:**
    *   The Server detects closure.
    *   The Server generates and broadcasts an `offline` `announce` message for the disconnected peer.
    *   Remaining peers update the status locally.

## 5. Global Operations (`global` module)

Operations that affect the overall state of a peer, not tied to a specific module instance.

### 5.1 Type: `clearAll`

*   **Direction:** Hero -> Sidekick (via Server)
*   **Purpose:** Instructs the receiving Sidekick peer to remove all its active module instances and reset its state.
*   **`target` / `src`:** Omitted.
*   **`payload`:** Null or omitted.

## 6. Core Module Interaction Message Types

These message types facilitate the primary purpose of Sidekick: controlling and receiving feedback from visual modules. These types (except potentially `error`) SHOULD only be sent by Hero after confirming Sidekick is online (via `system/announce`).

### 6.1 Hero -> Sidekick (via Server) - Module Control

*   **`spawn`**: Creates a new module instance in Sidekick. `target` is required. Payload contains initial configuration.
*   **`update`**: Modifies an existing module instance in Sidekick. `target` is required. Payload typically contains `action` and `options`.
*   **`remove`**: Destroys a module instance in Sidekick. `target` is required.

### 6.2 Sidekick -> Hero (via Server) - Module Feedback

*   **`event`**: Informs Hero about user actions or module events within Sidekick. `src` is required. Payload contains event details.
*   **`error`**: Reports an error encountered by Sidekick related to a specific module. `src` is required. Payload contains error message.

## 7. Module-Specific Payloads (`payload` structure)

This section details the expected structure of the `payload` object for different *module interaction* message `type` combinations (`spawn`, `update`, `event`, etc.). **Reminder:** All keys within `payload` and its nested objects (`options`, `config`, `valueRepresentation`, etc.) **MUST** use `camelCase`. *(Payloads for `system/announce` and `global/clearAll` are defined in Sections 4.2 and 5.1 respectively)*.

### 7.1 Module: `grid`

*   **`spawn` Payload:** (REQUIRED keys)
    ```json
    {
      "numColumns": number, // Number of columns
      "numRows": number     // Number of rows
    }
    ```
*   **`update` Payload:**
    *   Set Cell: `{ "action": "setCell", "options": { "x": number, "y": number, "color"?: string | null, "text"?: string | null } }`
    *   Clear Grid: `{ "action": "clear" }`
*   **`event` Payload:**
    ```json
    { "event": "click", "x": number, "y": number }
    ```

### 7.2 Module: `console`

*   **`spawn` Payload:** (REQUIRED keys)
    ```json
    {
      "showInput": boolean, // Whether to display the input area
      "text"?: string      // Optional initial text line
    }
    ```
*   **`update` Payload:**
    *   Append Text: `{ "action": "append", "options": { "text": string } }`
    *   Clear Console: `{ "action": "clear" }`
*   **`event` Payload:** (Sent when user submits text via input area)
    ```json
    { "event": "inputText", "value": string }
    ```

### 7.3 Module: `viz`

*   **`spawn` Payload:** `{}`
*   **`update` Payload:**
    ```json
    {
      "action": string,
      "variableName": string,
      "options": {
        "path"?: Array<string | number>,
        "valueRepresentation"?: VizRepresentation | null,
        "keyRepresentation"?: VizRepresentation | null,
        "length"?: number | null
      }
    }
    ```
    *   *(VizRepresentation is defined in Section 8)*

### 7.4 Module: `canvas`

*   **`spawn` Payload:**
    ```json
    { "width": number, "height": number, "bgColor"?: string }
    ```
*   **`update` Payload:**
    ```json
    {
      "action": string,
      "options": object, // Structure depends on action (see below)
      "commandId": string | number // REQUIRED command identifier
    }
    ```
    *   *Options examples:* `clear: { color? }`, `config: { strokeStyle?, fillStyle?, lineWidth? }`, `line: { x1, y1, x2, y2 }`, `rect: { x, y, width, height, filled? }`, `circle: { cx, cy, radius, filled? }` (keys camelCase)

### 7.5 Module: `control`

*   **`spawn` Payload:** `{}`
*   **`update` Payload:**
    *   Add Control:
        ```json
        {
          "action": "add",
          "controlId": string, // ID for the specific control being added
          "options": {
            "controlType": "button" | "textInput", // Type of control
            "config": { /* camelCase keys: text?, placeholder?, initialValue?, buttonText? */ }
          }
        }
        ```
    *   Remove Control: `{ "action": "remove", "controlId": string }`
*   **`event` Payload:** (Sent on user interaction)
    *   Button Click: ` { "event": "click", "controlId": string }`
    *   Text Input Submit: `{ "event": "inputText", "controlId": string, "value": string }`


## 8. Data Representation (`VizRepresentation`)

This structure is used within the `viz` module's `update` payload (`valueRepresentation`, `keyRepresentation`). **All keys MUST be `camelCase`.**

```typescript
interface VizRepresentation {
  type: string;
  value: any;
  length?: number;
  observableTracked?: boolean;
  id: string; // Unique ID for this representation node
}

// Example nested structure for a list:
// {
//   "type": "list", "id": "list_123_0",
//   "value": [
//     { "type": "int", "id": "int_456_1", "value": 10 },
//     { "type": "str", "id": "str_789_1", "value": "hello" }
//   ],
//   "length": 2, "observableTracked": false
// }
```

## 9. Error Handling

Sidekick -> Hero `error` messages use the standard structure with `type: "error"`, `module` (e.g., `grid`), and `src` (instance ID). The `payload` typically contains:

```json
{ "message": string }
```

## 10. Versioning and Extensibility

This protocol definition represents the current version. Future changes may occur.
*   Implementations should be robust to receiving messages with extra, unexpected fields.
*   Mandatory fields (e.g., `commandId` for Canvas, `peerId`/`role`/etc. for announce, `numColumns`/`numRows` for Grid spawn, `showInput` for Console spawn) must be present.
*   Keys within the `payload` object **MUST** use `camelCase`.
*   Peer version information is exchanged via the `system/announce` message (Section 4.2).