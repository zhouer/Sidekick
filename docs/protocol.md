# Sidekick Communication Protocol Specification

## 1. Introduction

This document specifies the **definitive communication protocol** used within the Sidekick ecosystem.
It defines the structure and meaning of messages exchanged between the **Hero** (user's script/library, e.g., `sidekick-py`) and the **Sidekick Frontend UI** (typically a React application running in a VS Code Webview or as a standalone web page), relayed via the **Sidekick Server** component (usually running within the VS Code Extension) or handled directly in a client-side Python environment like Pyodide.

Adherence to this protocol is **crucial** for interoperability between all components. Implementers of Hero libraries or Sidekick UI components **must** strictly follow this specification.

The protocol enables:
*   Peer Discovery & Status Management (`system` component)
*   Global Operations (`global` component)
*   Component Instance Control (creating, updating, removing UI elements, changing parent)
*   Component Feedback (sending user interaction events and errors back to the Hero)

## 2. Transport Layer

*   **Mechanism:**
    *   WebSocket (Default): Used when Hero runs in a separate process (e.g., standard Python) and UI is in VS Code Webview or browser.
    *   Direct JavaScript `postMessage` / event listeners: Used when Hero runs client-side (e.g., Pyodide in a Web Worker) and UI is in the main browser thread.
*   **Default Endpoint (WebSocket):** `ws://localhost:5163` (Configurable via Hero library functions and corresponding VS Code extension settings).
*   **Encoding:** Messages are encoded as JSON strings (UTF-8).
*   **Ordering:** The transport mechanism (WebSocket or reliable `postMessage` handling) **guarantees** message delivery order between a single Hero client and a single Sidekick UI client. This eliminates the need for sequence numbers within the protocol messages themselves for ordering purposes.

## 3. Base Message Format

All messages exchanged are JSON objects adhering to the following base structure:

```typescript
interface BaseMessage {
  /** Reserved for future use. Currently defaults to 0. */
  id: number;
  /** Identifies the target/source component type (e.g., "system", "global", or visual components like "grid", "console", "canvas", "viz", "label", "markdown", "button", "textbox", "row", "column"). */
  component: string;
  /** Specifies the action or event type (e.g., "spawn", "update", "remove", "announce", "event", "error", "clearAll", "changeParent"). */
  type: string;
  /** Target component instance ID (Required for Hero -> Sidekick component control messages: spawn, update, remove, changeParent). */
  target?: string;
  /** Source component instance ID (Required for Sidekick -> Hero feedback messages: event, error). */
  src?: string;
  /** Contains message-type-specific data. Keys MUST use camelCase. Can be null or omitted if no data is needed. */
  payload?: object | null;
}
```

### 3.1 Payload `camelCase` Convention

**ALL keys within the `payload` object, and any nested objects inside it (e.g., `options`, `config`, `valueRepresentation`), MUST use `camelCase` naming.**

This convention ensures consistency between the JavaScript-based frontend/server and potentially other language libraries.
Hero libraries (like `sidekick-py`) are responsible for converting their native conventions (e.g., `snake_case`) to `camelCase` before sending messages. Sidekick UI components expect to receive and send `camelCase` payloads.
**Failure to adhere to this will likely cause messages to be ignored or result in errors.**

## 4. Connection Lifecycle & Peer Discovery (`system` Component)

Handles peer status announcements and discovery.

### 4.1 Message: `system/announce`

*   **Direction:** Peer (Hero or Sidekick) -> Server/Other Peer -> Other Peers/Server
*   **Purpose:** Announces the peer's connection status (`online` / `offline`), role, and version. Signals readiness to communicate or graceful disconnection.
*   **`target` / `src`:** Omitted.
*   **Payload:** `SystemAnnouncePayload`

```typescript
interface SystemAnnouncePayload {
  /** Required: Unique identifier for the peer instance (e.g., UUID generated by the client). */
  peerId: string;
  /** Required: Role of the announcing peer. */
  role: "hero" | "sidekick";
  /** Required: Current connection status. */
  status: "online" | "offline";
  /** Required: Version string of the peer library (e.g., "0.0.4") or application. */
  version: string;
  /** Required: Timestamp when the announcement was generated (Unix epoch milliseconds). */
  timestamp: number;
}

interface SystemAnnounceMessage extends BaseMessage {
  id: number; // 0
  component: "system";
  type: "announce";
  payload: SystemAnnouncePayload;
  target?: never;
  src?: never;
}
```

**Connection Flow (WebSocket Example):**
1.  **Connect:** Peer (Hero/Sidekick) establishes WebSocket connection to Server.
2.  **Announce Online:** Peer immediately sends `system/announce` message with `status: "online"`.
3.  **Broadcast (Server):** Server relays this `online` announcement to all *other* connected peers.
4.  **History (Server):** Server sends a list of *currently online* peer announcements (from `lastAnnouncements` cache) **only to the newly connected peer**.
5.  **Ready State:** Peers use received announcements to track the status of others. Hero implementations **SHOULD** buffer non-`system` messages until they receive an `online` announce from at least one `sidekick` peer.
6.  **Announce Offline (Graceful):** Before intentionally closing the connection, a Peer **SHOULD** send a `system/announce` message with `status: "offline"`. The Server relays this.
7.  **Abnormal Disconnect (Server):** If a Peer disconnects without sending an offline announce, the Server detects the closure. It then generates an `offline` announce message on behalf of the disconnected Peer and broadcasts it to remaining Peers.
**Connection Flow (Pyodide Example):**
1.  **Initialize:** Sidekick UI initializes Pyodide Worker. Worker loads `sidekick-py`.
2.  **Announce Online (Sidekick UI to Worker):** UI sends `system/announce` (`role: "sidekick"`, `status: "online"`) to the Worker.
3.  **Hero Ready:** Worker's `sidekick-py` receives this, considers UI ready.
4.  **Announce Online (Worker to Sidekick UI):** Worker's `sidekick-py` sends `system/announce` (`role: "hero"`, `status: "online"`) back to the UI.
5.  **Announce Offline:** Graceful shutdown involves similar `offline` announcements.

## 5. Global Operations (`global` Component)

Affect the entire Sidekick UI state, not specific component instances.

### 5.1 Message: `global/clearAll`

*   **Direction:** Hero -> Sidekick
*   **Purpose:** Instructs the Sidekick UI to remove all currently displayed component instances, effectively resetting the panel to its initial state (e.g., only the root container).
*   **`target` / `src` / `payload` :** Omitted.

```typescript
interface GlobalClearAllMessage extends BaseMessage {
  id: number; // 0
  component: "global";
  type: "clearAll";
  payload?: never;
  target?: never;
  src?: never;
}
```

## 6. Core Component Interaction Message Types

These message types facilitate the control of specific UI component instances and the feedback from those instances.

*   **Hero -> Sidekick:**
    *   `spawn`: Creates a new component instance in the UI. Requires `target` (the ID for the new instance) and a component-specific `payload` containing initial configuration and `parent` ID.
    *   `update`: Modifies an existing component instance or performs actions within it. Requires `target` (the ID of the instance) and a component-specific `payload` describing the action and its options (e.g., `{ action: "setText", options: {...} }` or `{ action: "changeParent", options: {...} }`).
    *   `remove`: Destroys a specific component instance in the UI. Requires `target` (the ID of the instance to remove). Payload is usually `null` or omitted. When a container is removed, its children are recursively removed by the UI.
*   **Sidekick -> Hero:**
    *   `event`: Informs the Hero about user interactions or significant events within a specific component instance. Requires `src` (the ID of the instance generating the event) and a component-specific `payload` describing the event details.
    *   `error`: Reports an error encountered by a specific component instance or the Sidekick UI while processing a command related to that instance. Requires `src` (the ID of the instance where the error occurred) and a `payload` containing an error message.

## 7. Component-Specific Protocols

All `spawn` payloads for visual components accept an optional `parent` field:
```typescript
interface BaseSpawnPayload {
  /** Optional: The instance ID of the parent container component. If omitted, the component is added to the default top-level container (ID: "root"). */
  parent?: string;
}
```
The `update` message type includes a generic `changeParent` action for all components:
```typescript
interface ChangeParentUpdatePayload {
  action: "changeParent";
  options: {
    /** Required: The instance ID of the new parent container. Set to "root" to move to the top-level container. */
    parent: string;
    /** Optional: The instance ID of a sibling component before which this component should be inserted. If omitted, appended to the end of the parent's children. (Future use) */
    insertBefore?: string | null;
  };
}
```

### 7.1 `button` Component

**Purpose:** A standard clickable button that can trigger actions in the Hero script.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `ButtonSpawnPayload`
    ```typescript
    interface ButtonSpawnPayload extends BaseSpawnPayload {
      text: string; // Required: Text displayed on the button.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `ButtonUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    type ButtonUpdatePayload =
      | {
          action: "setText";
          options: {
            text: string; // Required: The new text for the button.
          };
        };
    ```
*   **`event` (Sidekick -> Hero)**
    *   **Payload:** `ButtonEventPayload`
    ```typescript
    interface ButtonEventPayload {
      event: "click"; // Indicates the button was clicked.
      // No additional data needed for a simple button click.
    }
    ```

### 7.2 `canvas` Component

**Purpose:** Provides a 2D drawing surface for rendering graphics programmatically. Supports drawing basic shapes, text, and includes a double buffering mechanism for smooth animations. Origin (0,0) is top-left.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `CanvasSpawnPayload`
    ```typescript
    interface CanvasSpawnPayload extends BaseSpawnPayload {
      width: number;  // Required: Canvas width in pixels (>0).
      height: number; // Required: Canvas height in pixels (>0).
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `CanvasUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    // --- Style Options (camelCase) ---
    interface CommonStyleOptions { lineColor?: string; lineWidth?: number; }
    interface FillableStyleOptions extends CommonStyleOptions { fillColor?: string | null; }
    // --- Action-Specific Options ---
    interface CanvasBaseBufferOptions { bufferId?: number | null; } // 0 or omitted for onscreen.
    interface ClearOptions extends CanvasBaseBufferOptions {}
    interface DrawLineOptions extends CanvasBaseBufferOptions, CommonStyleOptions { x1: number; y1: number; x2: number; y2: number; }
    interface DrawRectOptions extends CanvasBaseBufferOptions, FillableStyleOptions { x: number; y: number; width: number; height: number; }
    interface DrawCircleOptions extends CanvasBaseBufferOptions, FillableStyleOptions { cx: number; cy: number; radius: number; }
    interface DrawPolylineOptions extends CanvasBaseBufferOptions, CommonStyleOptions { points: Array<{x: number, y: number}>; } // Min 2 points.
    interface DrawPolygonOptions extends CanvasBaseBufferOptions, FillableStyleOptions { points: Array<{x: number, y: number}>; } // Min 3 points.
    interface DrawEllipseOptions extends CanvasBaseBufferOptions, FillableStyleOptions { cx: number; cy: number; radiusX: number; radiusY: number; }
    interface DrawTextOptions extends CanvasBaseBufferOptions { x: number; y: number; text: string; textColor?: string; textSize?: number; }
    interface CreateBufferOptions { bufferId: number; } // Required: bufferId > 0.
    interface DrawBufferOptions { sourceBufferId: number; targetBufferId: number; }
    interface DestroyBufferOptions { bufferId: number; } // Required: bufferId > 0.

    type CanvasUpdatePayload =
      | { action: "clear"; options: ClearOptions; }
      | { action: "drawLine"; options: DrawLineOptions; }
      | { action: "drawRect"; options: DrawRectOptions; }
      | { action: "drawCircle"; options: DrawCircleOptions; }
      | { action: "drawPolyline"; options: DrawPolylineOptions; }
      | { action: "drawPolygon"; options: DrawPolygonOptions; }
      | { action: "drawEllipse"; options: DrawEllipseOptions; }
      | { action: "drawText"; options: DrawTextOptions; }
      | { action: "createBuffer"; options: CreateBufferOptions; }
      | { action: "drawBuffer"; options: DrawBufferOptions; }
      | { action: "destroyBuffer"; options: DestroyBufferOptions; };
    ```
*   **`event` (Sidekick -> Hero)**
    *   **Payload:** `CanvasEventPayload`
    ```typescript
    interface CanvasEventPayload {
      event: "click";
      x: number; // X-coordinate of click relative to canvas.
      y: number; // Y-coordinate of click relative to canvas.
    }
    ```

### 7.3 `column` Container Component

**Purpose:** A layout container that arranges its child components vertically. The top-level implicit container (ID: "root") behaves like a Column.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `ColumnSpawnPayload`
    ```typescript
    interface ColumnSpawnPayload extends BaseSpawnPayload {
      // Column-specific layout options can be added here in the future if needed.
      // e.g., gap, justifyContent, alignItems. For now, UI uses defaults.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `ChangeParentUpdatePayload` (No other `column`-specific updates currently).
    ```typescript
    // type ColumnUpdatePayload = { action: "someColumnAction"; options: {...}; }; // Example
    // Currently, only ChangeParentUpdatePayload is applicable.
    ```
*   **`event` (Sidekick -> Hero)**: `Column` does not send events.

### 7.4 `console` Component

**Purpose:** Displays text output, similar to a standard terminal console, and optionally provides a field for user text input. Useful for logging messages, showing program status, or getting simple string inputs from the user.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `ConsoleSpawnPayload` - Configures the initial state of the console.
    ```typescript
    interface ConsoleSpawnPayload extends BaseSpawnPayload {
      showInput: boolean; // Required: If true, show input field.
      text?: string | null; // Optional: Initial text to display.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `ConsoleUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    type ConsoleUpdatePayload =
      | {
          action: "append";
          options: { text: string; }; // Required: Text to append.
        }
      | {
          action: "clear";
          options?: undefined | null;
        };
    ```
*   **`event` (Sidekick -> Hero)**
    *   **Payload:** `ConsoleEventPayload` - Reports user input submission.
    ```typescript
    interface ConsoleEventPayload {
      event: "submit";
      value: string; // Required: The text string submitted.
    }
    ```

### 7.5 `grid` Component

**Purpose:** Displays and interacts with a 2D grid of cells. Ideal for visualizing maps, game boards, matrices, or simple pixel art. Allows setting cell color and text, and reacting to user clicks on individual cells.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `GridSpawnPayload` - Defines the initial dimensions of the grid.
    ```typescript
    interface GridSpawnPayload extends BaseSpawnPayload {
      numColumns: number; // Required: Must be > 0.
      numRows: number;    // Required: Must be > 0.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `GridUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    type GridUpdatePayload =
      | {
          action: "setColor";
          options: { x: number; y: number; color: string | null; }; // color: CSS color, null to clear.
        }
      | {
          action: "setText";
          options: { x: number; y: number; text: string | null; }; // text: null or "" to clear.
        }
      | {
          action: "clearCell";
          options: { x: number; y: number; };
        }
      | {
          action: "clear"; // Clears all cells.
          options?: undefined | null;
        };
    ```
*   **`event` (Sidekick -> Hero)**
    *   **Payload:** `GridEventPayload` - Reports user interaction events.
    ```typescript
    interface GridEventPayload {
      event: "click";
      x: number; // 0-based column index.
      y: number; // 0-based row index.
    }
    ```

### 7.6 `label` Component

**Purpose:** Displays a single line of static or dynamic text.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `LabelSpawnPayload`
    ```typescript
    interface LabelSpawnPayload extends BaseSpawnPayload {
      text: string; // Required: Initial text to display.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `LabelUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    type LabelUpdatePayload =
      | {
          action: "setText";
          options: {
            text: string; // Required: The new text for the label.
          };
        };
    ```
*   **`event` (Sidekick -> Hero)**: `Label` does not send events.

### 7.7 `markdown` Component

**Purpose:** Renders Markdown formatted text content. Allows displaying rich text, lists, code blocks, links, and images parsed from a Markdown string.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `MarkdownSpawnPayload` - Defines the initial Markdown content.
    ```typescript
    interface MarkdownSpawnPayload extends BaseSpawnPayload {
      /** Required: The initial Markdown string to be rendered. */
      initialSource: string;
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `MarkdownUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    type MarkdownUpdatePayload =
      | {
          action: "setSource";
          options: {
            /** Required: The new Markdown string to render. */
            source: string;
          };
        };
    ```
*   **`event` (Sidekick -> Hero)**: `Markdown` component does not typically send events based on user interaction with the rendered content itself.

### 7.8 `row` Container Component

**Purpose:** A layout container that arranges its child components horizontally.

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `RowSpawnPayload`
    ```typescript
    interface RowSpawnPayload extends BaseSpawnPayload {
      // Row-specific layout options can be added here in the future if needed.
      // e.g., gap, justifyContent, alignItems. For now, UI uses defaults.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `ChangeParentUpdatePayload` (No other `row`-specific updates currently).
    ```typescript
    // type RowUpdatePayload = { action: "someRowAction"; options: {...}; }; // Example
    // Currently, only ChangeParentUpdatePayload is applicable.
    ```
*   **`event` (Sidekick -> Hero)**: `Row` does not send events.

### 7.9 `textbox` Component

**Purpose:** A single-line text input field allowing users to enter text. Hero script can read the value and be notified upon submission (e.g., Enter key press or blur).

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `TextboxSpawnPayload`
    ```typescript
    interface TextboxSpawnPayload extends BaseSpawnPayload {
      initialValue?: string; // Optional: Initial text in the textbox.
      placeholder?: string; // Optional: Placeholder text.
    }
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `TextboxUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    type TextboxUpdatePayload =
      | {
          action: "setValue"; // Sets the textbox content from Hero.
          options: {
            value: string; // Required: The new text content.
          };
        }
      | {
          action: "setPlaceholder";
          options: {
            placeholder: string; // Required: The new placeholder text.
          };
        };
    ```
*   **`event` (Sidekick -> Hero)**
    *   **Payload:** `TextboxEventPayload`
    ```typescript
    interface TextboxEventPayload {
      event: "submit"; // Text submitted (e.g., on Enter or blur).
      value: string;  // Required: The current text content of the textbox.
    }
    // Note: "change" event (on every keystroke) is not currently supported.
    ```

### 7.10 `viz` Component

**Purpose:** Displays Python variables and data structures (like lists, dictionaries, sets, custom objects) in an interactive, collapsible tree view. Supports `ObservableValue` for automatic updates.

**Core Data Structure:** `VizRepresentation`
```typescript
interface VizRepresentation {
  type: string; // Python data type (e.g., "int", "list", "object (ClassName)"). Special: "truncated", "recursive_ref", "error".
  value: any;   // JS primitive, or array of VizRepresentations (for list/set), or array of {key: VizRep, value: VizRep} (for dict), or object of {attrName: VizRep} (for object). String for "truncated", "error", etc. "None" for NoneType.
  length?: number; // Original Python container length.
  observableTracked?: boolean; // True if from an ObservableValue.
  id: string;       // Unique ID for this node.
}
```

**Message Types:**

*   **`spawn` (Hero -> Sidekick)**
    *   **Payload:** `VizSpawnPayload`
    ```typescript
    interface VizSpawnPayload extends BaseSpawnPayload {} // No specific options currently.
    ```
*   **`update` (Hero -> Sidekick)**
    *   **Payload:** `VizUpdatePayload | ChangeParentUpdatePayload`
    ```typescript
    interface VizUpdateOptions {
      path?: Array<string | number>; // Path from variableName to target element. Empty for root.
      valueRepresentation?: VizRepresentation | null; // New value representation.
      keyRepresentation?: VizRepresentation | null;   // Key rep for new dict items.
      length?: number | null; // New container length after operation.
    }
    interface VizUpdatePayload {
      action: string; // "set", "removeVariable", "setitem", "append", "delitem", "clear", etc.
      variableName: string; // Top-level variable name.
      options: VizUpdateOptions;
    }
    ```
*   **`event` (Sidekick -> Hero)**: Currently, `Viz` does not send events.

## 8. Error Handling (`error` Message Type)

Used by the Sidekick UI to report problems encountered while trying to process a command received from the Hero.

*   **Direction:** Sidekick -> Hero
*   **Purpose:** Informs the Hero script that an error occurred on the UI side.
*   **`src`:** (string, Required) The `target` ID from the original command message sent by the Hero that caused the error.
*   **Payload:** `ComponentErrorPayload`

```typescript
interface ComponentErrorPayload {
  message: string; // Required: A string describing the error.
}

interface ComponentErrorMessage extends BaseMessage {
  id: number; // 0
  component: string; // The component type associated with the error.
  type: "error";
  src: string; // Required: ID of the component instance where the error occurred.
  payload: ComponentErrorPayload;
  target?: never;
}
```

## 9. Versioning and Extensibility

*   This document defines a specific version of the protocol.
*   Peers exchange library/application versions via `system/announce`.
*   Implementations **SHOULD** be robust to receiving messages with extra, unexpected fields. Ignore unknown fields gracefully.
*   Implementations **MUST** validate the presence and basic type of **required** fields for messages they process. Missing required fields should typically result in the message being ignored and a warning logged, or an `error` message sent back.
*   Adding new components, actions, or modifying existing payloads in a way that breaks backward compatibility requires updating this specification and coordinating version bumps.