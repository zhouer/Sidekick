# Sidekick VS Code Extension Development Guide

## 1. Overview

This document describes the structure and implementation of the Sidekick VS Code extension (`sidekick-coding`). It focuses on how the extension integrates with VS Code, manages the Webview panel containing the React frontend, and runs the WebSocket server that relays messages between the Python library (Hero) and the Webview (Sidekick UI). This guide is for developers contributing to the extension itself.

The extension's main responsibilities include:
1.  Registering and handling VS Code commands (e.g., `sidekick.show`).
2.  Creating and managing the Webview panel (`vscode.WebviewPanel`).
3.  Loading the built React WebApp (`webapp/dist/`) into the Webview, ensuring proper asset loading and Content Security Policy (CSP).
4.  Starting, managing, and stopping the built-in WebSocket server (`ws` library).
5.  Relaying messages between connected Hero clients and Sidekick UI clients according to the [protocol specification](./protocol.md).
6.  Reading configuration settings from VS Code (`sidekick.websocket.port`, etc.).

## 2. Project Structure (`extension/`)

```
extension/
├── src/
│   ├── extension.ts        # Entry point (activate, deactivate)
│   ├── webviewPanel.ts     # Manages the VS Code Webview Panel lifecycle
│   ├── getWebviewContent.ts # Generates HTML for the Webview (loads React app)
│   ├── websocketServer.ts  # Implements the WebSocket relay server
│   └── types/              # Shared TypeScript types (Messages, Payloads)
├── build.mjs               # esbuild configuration for building the extension
├── package.json            # Extension manifest, dependencies, scripts
├── tsconfig.json           # TypeScript configuration
└── images/                 # Icon, etc.
```

## 3. Core Implementation Details

### 3.1. Activation & Lifecycle (`extension.ts`)

*   **`activate(context)`:** Called by VS Code when the extension is activated (e.g., by the `onCommand:sidekick.show` event).
    *   Registers the `sidekick.show` command, which calls `createOrShowSidekickPanel`.
    *   Adds the command disposable to `context.subscriptions`.
*   **`deactivate()`:** Called by VS Code when the extension is deactivated (e.g., VS Code closing, extension disabled/uninstalled).
    *   Calls `stopWebSocketServer()` to gracefully shut down the server. Returns the `Promise` from `stopWebSocketServer`.

### 3.2. Webview Panel Management (`webviewPanel.ts`)

*   **`createOrShowSidekickPanel(extensionUri, context)`:**
    *   Checks if `sidekickPanel` already exists; if so, reveals it.
    *   If not, creates a new `vscode.WebviewPanel` using `vscode.window.createWebviewPanel`.
        *   Sets panel ID (`sidekickPanel`), title (`Sidekick`), view column (`Beside`).
        *   **Crucially, configures `options`:**
            *   `enableScripts: true` to allow JavaScript in the Webview.
            *   `localResourceRoots: [vscode.Uri.joinPath(extensionUri, 'dist')]` **restricts** the Webview to loading resources only from the `extension/dist` directory (where the built React app resides). This is essential for security.
    *   Sets the Webview's HTML content using `getWebviewContent()`.
    *   Calls `startWebSocketServer()` to ensure the server is running.
    *   Registers an `onDidDispose` listener to clean up `sidekickPanel` and call `stopWebSocketServer()` when the panel is closed. Adds this disposable to `context.subscriptions`.

### 3.3. Webview Content Loading (`getWebviewContent.ts`)

*   **Purpose:** Generates the final HTML string to be loaded into the Webview panel.
*   **Steps:**
    1.  Constructs the path to the built React app's entry point (`dist/index.html`).
    2.  Reads the `index.html` file content.
    3.  Generates a random `nonce` for script tags.
    4.  Reads WebSocket host/port configuration for the CSP `connect-src` directive.
    5.  Defines the **Content Security Policy (CSP)** string, using `webview.cspSource` for standard directives (`style-src`, `script-src`, `font-src`, `img-src`) and explicitly adding the WebSocket `connect-src`.
    6.  Injects the CSP `<meta>` tag into the HTML `<head>`.
    7.  Replaces relative asset paths (e.g., `/assets/index-*.js`) in `src` and `href` attributes with absolute `vscode-resource:` URIs generated by `webview.asWebviewUri()`. This allows the Webview to load the bundled CSS and JS.
    8.  Adds the `nonce` attribute to all `<script src="...">` tags to comply with the CSP.

### 3.4. WebSocket Server (`websocketServer.ts`)

*   **Purpose:** Acts as a central relay/broker for messages between potentially multiple Hero clients and Sidekick UI clients.
*   **Implementation:** Uses the `ws` library.
*   **`startWebSocketServer()`:**
    *   Checks if the server (`wss`) is already running.
    *   Reads host/port from VS Code configuration (`sidekick.websocket.host`/`port`).
    *   Creates a new `WebSocketServer` instance.
    *   Handles `listening` event (logs success, resolves promise).
    *   Handles `error` event (logs error, shows message in VS Code, rejects promise, cleans up state). Specifically handles `EADDRINUSE`.
    *   Handles `connection` event (when a new client connects):
        *   Sets up `message`, `close`, and `error` handlers for the individual client `WebSocket` (`ws`).
*   **Client `message` Handler:**
    *   Parses incoming JSON data.
    *   **Handles `system/announce`:**
        *   Validates payload.
        *   If `status: "online"`: Stores `PeerInfo` in `connectedPeers` map, sends connection history (other online peers' announces) back to the new client, updates `lastAnnouncements`, broadcasts the new `online` announce to *other* clients.
        *   If `status: "offline"`: Updates `lastAnnouncements`, broadcasts the `offline` announce to *other* clients.
    *   **Handles Other Messages:** Relays the message to all *other* connected clients using `broadcastMessage()`.
*   **Client `close` Handler:**
    *   Removes the client from `connectedPeers`.
    *   If the peer hadn't sent an `offline` announce, generates and broadcasts one on its behalf.
*   **Client `error` Handler:** Logs the error.
*   **`stopWebSocketServer()`:**
    *   Closes all active client connections (`client.close(1001)`).
    *   Closes the main server (`wss.close()`).
    *   Clears state (`wss`, `connectedPeers`, `lastAnnouncements`). Resolves promise.
*   **Logging:** Uses a dedicated VS Code `OutputChannel` ("Sidekick Server") for visibility.

### 3.5. Interaction with VS Code APIs

*   **Command API (`vscode.commands`):** Registering `sidekick.show`.
*   **Window API (`vscode.window`):** Creating panels (`createWebviewPanel`), showing messages (`showErrorMessage`).
*   **Webview API (`vscode.Webview`, `vscode.WebviewPanel`):** Setting HTML, options, handling disposal, generating URIs (`asWebviewUri`), CSP source (`cspSource`).
*   **Workspace API (`vscode.workspace`):** Reading configuration (`getConfiguration`).
*   **URI API (`vscode.Uri`):** Joining paths (`joinPath`).
*   **Extension Context (`vscode.ExtensionContext`):** Managing disposables (`subscriptions`), getting `extensionUri`.

## 4. Build Process

*   Uses `esbuild` via the `build.mjs` script for fast bundling of the TypeScript source code into JavaScript output in the `out/` directory (as specified in `package.json`'s `main` field).
*   The `vscode:prepublish` script ensures the build runs before packaging the extension.
*   The React WebApp (`webapp/`) needs to be built separately (`npm run build` inside `webapp/`) to generate the `dist/` directory that the extension loads.

## 5. Troubleshooting

*   **Extension Activation Failed:** Check VS Code Developer Tools console (Help -> Toggle Developer Tools) for errors during activation. Ensure `package.json` is valid.
*   **Webview Not Loading / Blank:**
    *   Check `getWebviewContent.ts` logs (via VS Code Dev Tools console) for errors reading `index.html`. Ensure `webapp/dist/` exists (run `npm run build` in `webapp`).
    *   Check CSP errors in the Webview DevTools (Open Webview -> Command Palette -> "Developer: Open Webview Developer Tools"). Verify `localResourceRoots` in `webviewPanel.ts` correctly points *only* to the `dist` directory. Verify `asWebviewUri` generated correct paths.
*   **WebSocket Server Failed to Start:** Check "Sidekick Server" OutputChannel. Common issue is `EADDRINUSE` (port conflict). Check if another process (maybe Vite dev server from `webapp`) is using the configured port. Modify `sidekick.websocket.port` setting in VS Code if needed.
*   **Messages Not Relayed:** Check "Sidekick Server" OutputChannel logs. Verify clients are connecting and sending valid JSON. Check if `system/announce` is handled correctly. Ensure `broadcastMessage` isn't encountering errors. Check client-side implementations for adherence to the protocol.